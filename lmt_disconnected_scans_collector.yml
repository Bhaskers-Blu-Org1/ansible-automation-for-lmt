---
- hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:  
    - name: "Creating temporary scans directory"
      file:
        path: "{{temp_file_storage_path | default('./tmp')}}/"
        state: directory

- hosts: unix_endpoints
  gather_facts: no

  tasks:
    - name: Getting info about scans
      shell: "ls {{scanner_output_path}}"
      changed_when: false
      register: files_to_copy

    - name: "Fetch packages from endpoints"
      fetch: 
        src: "{{scanner_output_path}}/{{item}}"
        dest: "{{temp_file_storage_path | default('./tmp')}}/"
        flat: yes
      loop: "{{ files_to_copy.stdout_lines }}"

    - name: Clean up packages on endpoints   
      file:
        state: absent
        path: "{{item}}"
      loop: "{{ files_to_copy }}"

- hosts: lmtserver
  gather_facts: no
  tasks:
    - name: "Uploading scans to ILTM Server"
      copy:
        src: "{{temp_file_storage_path | default('./tmp')}}/"
        dest: "{{lmt_datasource_path}}/"

- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: "Cleaning scans from Control Node"
      file:
        path: "{{temp_file_storage_path | default('./tmp')}}/"
        state: absent
...
